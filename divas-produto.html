<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
  <title>Produto - Divas</title>
  <link rel="icon" type="image/png" href="divas.png">
  <style>
    /* ----------------
       CSS completo (produto) — estilo consistente com Divas
       ---------------- */
    html,body{margin:0;padding:0;height:100%}
    *{box-sizing:border-box}
    body{font-family:Arial,Helvetica,sans-serif;background:#fff;display:flex;flex-direction:column;min-height:100vh}
    .nav-wrapper{position:sticky;top:0;background:#fff;z-index:1000}
    .header{display:flex;justify-content:space-between;align-items:center;padding:8px 16px}
    .menu-icon,.bag-icon{font-size:28px;cursor:pointer;position:relative}
    .bag-icon .cart-count{position:absolute;top:-4px;right:-8px;background:#ff0000;color:#fff;font-size:12px;padding:2px 6px;border-radius:12px;display:none}
    .logo img{max-height:80px;width:auto;cursor:pointer}
    .search-container{display:flex;padding:0 16px 16px}
    .search-input{flex:1;padding:12px;border:1px solid #ccc;border-radius:8px 0 0 8px;font-size:16px;background:#f2f2f2;outline:none}
    .search-button{background:#ff69b4;border:none;padding:0 16px;border-radius:0 8px 8px 0;display:flex;align-items:center;justify-content:center;cursor:pointer}
    .search-button img{height:36px}
    .categories-container{display:flex;gap:16px;overflow-x:auto;padding:8px 16px 16px;scroll-behavior:smooth}
    .category{cursor:pointer;white-space:nowrap;padding:8px 0;font-weight:normal;color:#333}
    .main-content{flex:1;display:flex;flex-direction:column}
    .produto-container{padding:16px;min-height:300px}
    .produtos-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:24px;padding:16px;min-height:300px}
    .produto{cursor:pointer}
    .produto img{width:100%;height:240px;object-fit:cover;border-radius:8px;margin-bottom:12px}
    .produto .nome{font-size:14px;font-weight:700;margin-bottom:8px;text-transform:capitalize}
    .produto .preco{font-size:20px;font-weight:700;margin-bottom:8px}
    .produto .parcelamento,.produto .extra{font-size:13px;margin-bottom:8px}
    .produto .extra{color:#007bff}
    .breadcrumb-list{font-size:14px;color:#666;margin-bottom:16px}
    .breadcrumb-list a{color:#007bff;text-decoration:none}
    .carousel img{width:100%;height:350px;object-fit:cover;border-radius:8px}
    .badge{position:absolute;top:8px;left:8px;background:rgba(255,0,0,.85);color:#fff;padding:4px 8px;border-radius:4px;font-size:14px}
    .counter{position:absolute;bottom:8px;right:8px;background:rgba(0,0,0,.6);color:#fff;padding:4px 8px;border-radius:12px;font-size:14px}
    .thumbnails{display:flex;justify-content:center;gap:8px;margin-bottom:16px}
    .thumbnails img{width:60px;height:60px;object-fit:cover;border:2px solid #ddd;border-radius:4px;cursor:pointer}
    .thumbnails img.active{border-color:#007bff}
    .produto-nome{font-size:24px;font-weight:700;color:#333;margin-bottom:8px}
    .produto-preco{font-size:24px;font-weight:700;color:#000;margin-bottom:8px}
    .options{margin-bottom:16px}
    .option-swatch{display:inline-block;padding:6px 12px;border:2px solid #ccc;border-radius:4px;cursor:pointer;margin-right:8px}
    .option-swatch.selected{border-color:#000}
    .purchase-controls{display:flex;align-items:center;gap:8px;margin-bottom:16px}
    .qty-controls{display:flex;align-items:center;border:1px solid #ccc;border-radius:8px}
    .qty-controls button{background:none;border:none;font-size:18px;padding:8px 12px;cursor:pointer}
    .qty-controls .qty{padding:0 12px;font-size:18px;min-width:24px;text-align:center}
    .buy-btn{flex:1;background:#ff69b4;color:#fff;border:none;padding:12px;border-radius:8px;font-size:16px;cursor:pointer}
    .descricao{font-size:14px;color:#333;line-height:1.5;margin-top:8px}
    #breadcrumb{display:none;background:#fff;border-bottom:1px solid #eee;padding:8px 16px}
    #breadcrumb .path{font-size:14px;color:#007bff;cursor:pointer;text-decoration:underline}
    .header-row{display:flex;justify-content:space-between;align-items:center;margin-top:8px}
    .header-row .title{font-weight:700;font-size:20px;text-transform:uppercase}
    .header-row .count{font-size:14px;color:#555}

    /* ---------- Overlay (menu hambúrguer no estilo Divas) ---------- */
    #overlayMenu{position:fixed;top:0;left:0;width:100%;height:100%;background:#fff;transform:translateX(-100%);transition:transform .3s ease;z-index:2000;padding:60px 20px;display:flex;flex-direction:column}
    #overlayMenu.open{transform:translateX(0)}
    #overlayMenu .close-btn{position:absolute;top:16px;right:16px;font-size:32px;cursor:pointer}
    /* container e estilo de links - empilhado, espaçado, sem negrito, separador suave */
    #overlayMenu nav{display:flex;flex-direction:column;gap:10px;margin-top:20px;max-width:420px;width:100%}
    #overlayMenu nav a{display:block;padding:14px 12px;font-size:18px;font-weight:400;color:#111;text-decoration:none;text-transform:uppercase;border-radius:8px;background:transparent;border-bottom:1px solid rgba(0,0,0,0.06);line-height:1.0}
    #overlayMenu nav a:hover{background:rgba(0,0,0,0.03)}
    /* --------------------------------------------------------------- */

    .site-footer{background:#ff69b4;color:#fff;padding:16px;margin-top:auto}
    .site-footer a{color:inherit;text-decoration:none}
    .flying-image{position:fixed;z-index:9999;pointer-events:none;will-change:transform,opacity;transition:transform .7s cubic-bezier(.2,.8,.2,1),opacity .7s ease;border-radius:8px;box-shadow:0 8px 20px rgba(0,0,0,.25)}
    @media(max-width:480px){.produtos-grid{grid-template-columns:1fr 1fr}.produto img{height:220px}}
  </style>
</head>
<body>
  <!-- overlay menu -->
  <div id="overlayMenu" aria-hidden="true">
    <div class="close-btn">&times;</div>
    <nav>
      <a href="divas-index.html" id="home-link">Início</a>
      <a href="#" id="all-products-link">Produtos</a>
      <a href="miss-index.html">MISS FIT BEACHWEAR</a>
      <a href="divas-contato.html">Contato</a>
    </nav>
  </div>

  <!-- nav -->
  <div class="nav-wrapper">
    <header class="header">
      <div class="menu-icon" id="menuBtn">&#9776;</div>
      <a href="divas-index.html" class="logo"><img src="logodivas.webp" alt="Logo"></a>
      <a href="carrinho.html" class="bag-icon" id="cart-icon">&#128717;<span class="cart-count" id="cart-count">0</span></a>
    </header>

    <div class="search-container">
      <input class="search-input" type="text" placeholder="O que você está procurando?">
      <button class="search-button"><img src="lupa.webp" alt="Buscar"></button>
    </div>

    <div id="cats" class="categories-container">
      <div class="category">BRINCOS</div>
      <div class="category">ANÉIS</div>
      <div class="category">BRACELETES</div>
      <div class="category">COLARES</div>
      <div class="category">CONJUNTOS</div>
      <div class="category">PULSEIRAS</div>
      <div class="category">PERFUMES</div>
      <div class="category">BOLSAS</div>
      <div class="category">CINTOS</div>
      <div class="category">ÓCULOS</div>
    </div>
  </div>

  <!-- main -->
  <div class="main-content">
    <div id="breadcrumb">
      <span class="path">Início</span>
      <span class="separator">&gt;</span>
      <span class="crumbName"></span>
      <div class="header-row">
        <span class="title"></span>
        <span class="count"></span>
      </div>
    </div>

    <div class="produto-container" id="produto"></div>

    <div id="produtos" class="produtos-grid" style="display:none;"></div>
  </div>

  <footer class="site-footer">
    <div class="footer-item instagram"><a href="https://www.instagram.com/divasbijouxshoes?igsh=MW55M2QzbTJnaGF4bg==" target="_blank" rel="noopener"><img src="instagramicon.png" alt="Instagram" style="width:20px;vertical-align:middle"></a></div>
    <div class="footer-item"><a href="https://wa.me/5598992124926" target="_blank" rel="noopener">5598992124926</a></div>
    <div class="footer-item"><a href="tel:+5589982124926">98992124926</a></div>
    <div class="footer-item copyright">© Flowmize – 2025. Todos os direitos reservados.</div>
  </footer>

  <script>
    /***** CONFIG: coloque aqui a URL do Apps Script do catálogo *****/
    const APPSCRIPT_URL = "https://script.google.com/macros/s/AKfycbyMEY0_WEeZaFcRBaGqXM29Z5JlP0VnWyP_eW7upDKF-9EAXmtmpvt7lArtkuu87xZl/exec";

    /***** Carrinho helpers *****/
    const CART_KEY = 'cartItems';
    function getCartItems(){ try{ return JSON.parse(localStorage.getItem(CART_KEY)) || []; }catch{ return []; } }
    function setCartItems(items){ localStorage.setItem(CART_KEY, JSON.stringify(items)); renderCartCount(); }
    function renderCartCount(){ const el=document.getElementById('cart-count'); const items=getCartItems(); const total=items.reduce((s,i)=> s + (parseInt(i.quantidade||0,10)||0),0); el.textContent=total; el.style.display = total>0 ? 'inline-block' : 'none'; }
    document.addEventListener('visibilitychange', ()=>{ if(!document.hidden) renderCartCount(); });
    document.addEventListener('DOMContentLoaded', ()=> renderCartCount());

    /***** Utils *****/
    function safeJSONparseMaybeEncoded(param){
      if(!param) return null;
      try{ const decoded = decodeURIComponent(param); return JSON.parse(decoded); }catch(e1){ try{ return JSON.parse(param); }catch(e2){ if(typeof param==='string' && param.indexOf(',')!==-1) return param.split(',').map(s=>s.trim()).filter(Boolean); return null; } }
    }
    function normalizeText(text){ if(!text) return ''; try{ return text.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim(); }catch{ return String(text).toLowerCase().trim(); } }

    /***** Estado *****/
    let allProdutos = [];
    let currentProduct = null;
    let lastRenderedList = [];
    let catalogLoaded = false;
    let catalogResolve;
    const catalogReady = new Promise(resolve => { catalogResolve = resolve; });

    /***** URL params (se vier produto via link da grade) *****/
    const urlParams = new URLSearchParams(window.location.search);
    const paramProduto = urlParams.get('produto') ? decodeURIComponent(urlParams.get('produto')) : '';
    const paramImagensRaw = urlParams.get('imagens') || null;
    const paramOpcoesRaw = urlParams.get('opcoes') || null;
    const providedImagens = safeJSONparseMaybeEncoded(paramImagensRaw);
    const providedOpcoes = safeJSONparseMaybeEncoded(paramOpcoesRaw);

    /***** Show product (UI) *****/
    function showProdutoFromData(prod){
      if(!prod) return;
      currentProduct = prod;
      window.scrollTo({top:0,behavior:'smooth'});
      const container = document.getElementById('produto');
      document.getElementById('produtos').style.display = 'none';
      document.getElementById('breadcrumb').style.display = 'none';

      const nome = prod.nome || '';
      const images = Array.isArray(prod.imagens) ? prod.imagens : (prod.imagens ? [prod.imagens] : []);
      const options = Array.isArray(prod.opcoes) ? prod.opcoes : (prod.opcoes ? [prod.opcoes] : []);
      const status = prod.status || '';
      const desc = prod.descricao || '';
      let preco = prod.preco || '';
      const extra = prod.mensagem || '';
      const parc = prod.parcelamento || '';

      // format price (mínimo)
      preco = (preco||'').toString().trim(); preco = preco.replace(/[^\d.,]/g,'');
      if(preco && !preco.includes(',')){ if(preco.indexOf('.')!==-1) preco = preco.replace('.',','); else preco = preco + ',00'; }

      let html = `<div class="breadcrumb-list"><a href="divas-index.html">Início</a> &gt; ${nome}</div>`;
      html += `<div class="carousel" style="position:relative;">${status ? `<div class="badge">${status}</div>` : ''}<img id="carousel-image" src="" alt="${nome}"><div class="counter" id="image-counter"></div></div>`;
      html += `<div class="thumbnails" id="thumbnails"></div>`;
      html += `<div class="produto-nome">${nome}</div>`;
      html += `<div class="produto-preco">R$ ${preco}</div>`;
      if(parc) html += `<div class="produto-parcelamento">${parc}</div>`;
      if(extra) html += `<div class="produto-extra">${extra}</div>`;
      if(options && options.length) html += `<div class="options"><div class="options-label">Opções:</div><div id="option-list"></div></div>`;

      html += `
        <div class="purchase-controls">
          <div class="qty-controls">
            <button id="decrease">-</button>
            <div class="qty" id="quantity">1</div>
            <button id="increase">+</button>
          </div>
          <button class="buy-btn" id="buy-btn">ADICIONAR AO CARRINHO</button>
        </div>
        <strong>Compra protegida</strong>
        <div class="info-section">Seus dados cuidados durante toda a compra.</div><hr>
        <strong>Trocas e devoluções</strong>
        <div class="info-section">Se não gostar, você pode trocar ou devolver em até 7 dias após a entrega.</div><hr>
        <strong>Descrição</strong>
        <div class="descricao">${desc}</div>
      `;
      container.innerHTML = html;

      // imagens & thumbs
      const imgEl = document.getElementById('carousel-image');
      const counterEl = document.getElementById('image-counter');
      const thumbsEl = document.getElementById('thumbnails');

      let idx = 0;
      function showImage(i){
        if(!images[i]) return;
        idx = i;
        imgEl.src = images[i];
        counterEl.textContent = `${i+1}/${images.length}`;
        thumbsEl.querySelectorAll('img').forEach((t,j)=> t.classList.toggle('active', j===i));
      }
      images.forEach((src,i)=>{
        const t = document.createElement('img');
        t.src = src;
        t.alt = nome;
        t.onclick = ()=> showImage(i);
        thumbsEl.appendChild(t);
      });
      if(images.length>0){ showImage(0); const f=thumbsEl.querySelector('img'); if(f) f.classList.add('active'); } else { imgEl.style.display='none'; counterEl.style.display='none'; }

      // opções
      if(options && options.length){
        const list = document.getElementById('option-list');
        options.forEach(opt=>{
          const sw = document.createElement('div');
          sw.className='option-swatch'; sw.textContent = opt;
          sw.onclick = ()=>{ document.querySelectorAll('.option-swatch').forEach(x=>x.classList.remove('selected')); sw.classList.add('selected'); };
          list.appendChild(sw);
        });
      }

      // quantidade
      let qty = 1;
      document.getElementById('decrease').onclick = ()=>{ if(qty>1) qty--; document.getElementById('quantity').textContent = qty; };
      document.getElementById('increase').onclick = ()=>{ qty++; document.getElementById('quantity').textContent = qty; };

      // comprar
      document.getElementById('buy-btn').onclick = ()=>{
        const opcEl = document.querySelector('.option-swatch.selected');
        const opcao = opcEl ? opcEl.textContent : null;
        const productName = nome;
        const precoText = preco;
        const quantidade = parseInt(document.getElementById('quantity').textContent,10) || 1;
        const sourceImg = document.getElementById('carousel-image');
        if(sourceImg && sourceImg.src){
          flyImageToCart(sourceImg).then(()=> addToCartAndPersist({nome:productName,preco:precoText,quantidade,opcao,imagens:images}));
        } else {
          addToCartAndPersist({nome:productName,preco:precoText,quantidade,opcao,imagens:images});
        }
      };
    }

    function addToCartAndPersist(item){
      const items = getCartItems();
      const exists = items.find(i => i.nome === item.nome && (i.opcao||'') === (item.opcao||''));
      if(exists) exists.quantidade = (parseInt(exists.quantidade||0,10)||0) + (parseInt(item.quantidade||0,10)||0);
      else { item.quantidade = parseInt(item.quantidade||0,10)||0; items.push(item); }
      setCartItems(items);
    }

    function flyImageToCart(sourceImg){
      return new Promise((resolve)=>{
        try{
          const rect = sourceImg.getBoundingClientRect();
          const clone = sourceImg.cloneNode(true);
          clone.className = 'flying-image';
          clone.style.width = rect.width + 'px';
          clone.style.height = rect.height + 'px';
          clone.style.left = rect.left + 'px';
          clone.style.top = rect.top + 'px';
          clone.style.opacity = '1';
          document.body.appendChild(clone);
          const cartIcon = document.getElementById('cart-icon');
          const cartRect = cartIcon.getBoundingClientRect();
          const targetX = cartRect.left + (cartRect.width/2) - (rect.left + rect.width/2);
          const targetY = cartRect.top + (cartRect.height/2) - (rect.top + rect.height/2);
          const scale = 0.18;
          requestAnimationFrame(()=> { clone.style.transform = `translate(${targetX}px, ${targetY}px) scale(${scale})`; clone.style.opacity = '0.2'; });
          clone.addEventListener('transitionend', function handler(){ clone.removeEventListener('transitionend', handler); clone.remove(); resolve(); });
          setTimeout(()=>{ if(document.body.contains(clone)){ clone.remove(); resolve(); } }, 1200);
        }catch(e){ console.warn('fly failed', e); resolve(); }
      });
    }

    /***** FETCH CATALOG (fetch + JSONP fallback) *****/
    function fetchCatalogWithFallback(){
      const url = APPSCRIPT_URL + '?_=' + Date.now();
      return fetch(url, { method:'GET', cache:'no-store', mode:'cors' })
        .then(r => { if(!r.ok) throw new Error('Fetch não ok'); return r.json().catch(()=> { throw new Error('JSON inválido'); }); })
        .catch(()=> fetchCatalogJSONP());
    }
    function fetchCatalogJSONP(){
      return new Promise((resolve,reject)=>{
        const cb = '__divasProdCB' + Date.now() + Math.floor(Math.random()*1000);
        const script = document.createElement('script');
        const url = APPSCRIPT_URL + (APPSCRIPT_URL.indexOf('?')===-1 ? '?' : '&') + 'callback=' + cb + '&_=' + Date.now();
        window[cb] = function(data){ try{ delete window[cb]; }catch{} if(script.parentNode) script.parentNode.removeChild(script); resolve(data); };
        script.src = url;
        script.onerror = function(){ try{ delete window[cb]; }catch{} if(script.parentNode) script.parentNode.removeChild(script); reject(new Error('JSONP load error')); };
        document.head.appendChild(script);
        setTimeout(()=>{ if(window[cb]){ try{ delete window[cb]; }catch{} if(script.parentNode) script.parentNode.removeChild(script); reject(new Error('JSONP timeout')); } }, 9000);
      });
    }

    /***** Render produtos grid (quando aplicável) - ao clicar navega com reload para forçar exibição do produto *****/
    function renderProdutosGrid(list){
      const g = document.getElementById('produtos');
      document.getElementById('produto').style.display = 'none';
      g.style.display = 'grid';
      g.innerHTML = '';
      lastRenderedList = (list || []).slice();

      if(!list || list.length === 0){
        g.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:20px">Nenhum produto encontrado</div>';
        return;
      }
      list.forEach(p=>{
        if(!p.nome) return;
        const d = document.createElement('div'); d.className='produto';
        d.setAttribute('data-nome', p.nome);
        const img = (p.imagens && p.imagens[0]) ? p.imagens[0] : '';
        d.innerHTML = `
          <img src="${img}" alt="${p.nome}" onerror="this.src='https://via.placeholder.com/300x300?text=Imagem+N%C3%A3o+Encontrada'">
          <div class="nome">${p.nome}</div>
          <div class="preco">${p.preco || ''}</div>
          ${p.parcelamento ? `<div class="parcelamento">${p.parcelamento}</div>` : ''}
          ${p.mensagem ? `<div class="extra">${p.mensagem}</div>` : ''}
        `;
        // Navegar para a mesma página com params (força reload)
        d.addEventListener('click', (ev)=>{
          ev.stopPropagation();
          const params = new URLSearchParams();
          params.set('produto', p.nome || '');
          if(p.imagens) params.set('imagens', encodeURIComponent(JSON.stringify(p.imagens)));
          if(p.opcoes) params.set('opcoes', encodeURIComponent(JSON.stringify(p.opcoes)));
          if(p.status) params.set('status', encodeURIComponent(p.status));
          if(p.descricao) params.set('descricao', encodeURIComponent(p.descricao));
          if(p.preco) params.set('preco', encodeURIComponent(p.preco));
          if(p.mensagem) params.set('mensagem', encodeURIComponent(p.mensagem));
          if(p.parcelamento) params.set('parcelamento', encodeURIComponent(p.parcelamento));
          window.location.href = window.location.pathname + '?' + params.toString();
        });
        g.appendChild(d);
      });
    }

    /***** Category mapping & filter (simples e robusto) *****/
    const categoryMap = {
      'BRINCOS':['brinco','brincos'],
      'ANÉIS':['anel','aneis','anéis'],
      'BRACELETES':['bracelete','braceletes','bracelet'],
      'COLARES':['colar','colares'],
      'CONJUNTOS':['conjunto','conjuntos','kit','kits'],
      'PULSEIRAS':['pulseira','pulseiras'],
      'PERFUMES':['perfume','perfumes'],
      'BOLSAS':['bolsa','bolsas'],
      'CINTOS':['cinto','cintos'],
      'ÓCULOS':['óculos','oculos']
    };
    function getTermsForCategory(cat){ const key=(cat||'').toUpperCase(); return categoryMap[key] || [normalizeText(cat)]; }
    function filterByCategoryName(catName){
      const terms = getTermsForCategory(catName);
      return (allProdutos||[]).filter(p=>{
        if(!p) return false;
        const catField = normalizeText(p.categoria || p.category || '');
        if(catField && terms.some(t=> catField.includes(t))) return true;
        const tagField = normalizeText(p.tag || p.tags || '');
        if(tagField && terms.some(t=> tagField.includes(t))) return true;
        const nm = normalizeText(p.nome || '');
        if(nm && terms.some(t=> nm.includes(t))) return true;
        return false;
      });
    }

    /***** UI handlers (categorias, menu, busca, breadcrumb) *****/
    function setupUIHandlers(){
      // categories click
      document.querySelectorAll('.category').forEach(el=>{
        el.addEventListener('click', async ()=>{
          await catalogReady;
          const name = el.textContent.trim();
          const filtered = filterByCategoryName(name);
          document.getElementById('produtos').style.display = '';
          renderProdutosGrid(filtered);
          // breadcrumb
          document.getElementById('breadcrumb').style.display = 'block';
          document.querySelector('#breadcrumb .path').textContent = 'Início';
          document.querySelector('#breadcrumb .crumbName').textContent = name.toLowerCase();
          document.querySelector('#breadcrumb .header-row .title').textContent = name.toUpperCase();
          document.querySelector('#breadcrumb .header-row .count').textContent = `${filtered.length} produto${filtered.length !== 1 ? 's' : ''}`;
          document.getElementById('produto').style.display = 'none';
        });
      });

      // all products (menu)
      document.getElementById('all-products-link').addEventListener('click', async (e)=>{
        e.preventDefault();
        await catalogReady;
        const sorted = [...(allProdutos||[])].sort((a,b)=> (a.nome||'').localeCompare(b.nome||'','pt',{sensitivity:'base'}));
        renderProdutosGrid(sorted);
        document.getElementById('breadcrumb').style.display = 'block';
        document.querySelector('#breadcrumb .path').textContent = 'Início';
        document.querySelector('#breadcrumb .crumbName').textContent = 'Todos os Produtos';
        document.querySelector('#breadcrumb .header-row .title').textContent = 'TODOS OS PRODUTOS';
        document.querySelector('#breadcrumb .header-row .count').textContent = `${sorted.length} produto${sorted.length !==1 ? 's' : ''}`;
        document.getElementById('overlayMenu').classList.remove('open');
        document.body.style.overflow = '';
      });

      // breadcrumb back
      document.querySelector('#breadcrumb .path').addEventListener('click', ()=>{
        document.getElementById('produtos').style.display = 'none';
        document.getElementById('produto').style.display = '';
        document.getElementById('breadcrumb').style.display = 'none';
        window.history.pushState({}, '', window.location.pathname);
      });

      // search
      const si = document.querySelector('.search-input');
      const sb = document.querySelector('.search-button');
      si.addEventListener('input', async ()=>{
        await catalogReady;
        const t = si.value.trim();
        if(t === ''){
          document.getElementById('produtos').style.display = 'none';
          document.getElementById('produto').style.display = '';
          document.getElementById('breadcrumb').style.display = 'none';
          return;
        }
        const normalized = normalizeText(t);
        const filtered = (allProdutos||[]).filter(p => normalizeText(p.nome||'').includes(normalized));
        renderProdutosGrid(filtered);
        document.getElementById('breadcrumb').style.display = 'block';
        document.querySelector('#breadcrumb .path').textContent = 'Início';
        document.querySelector('#breadcrumb .crumbName').textContent = t.toLowerCase();
        document.querySelector('#breadcrumb .header-row .title').textContent = t.toUpperCase();
        document.querySelector('#breadcrumb .header-row .count').textContent = `${filtered.length} produto${filtered.length !== 1 ? 's' : ''}`;
      });
      sb.addEventListener('click', ()=> si.dispatchEvent(new Event('input')));

      // overlay open/close
      const overlay = document.getElementById('overlayMenu');
      const menuBtn = document.getElementById('menuBtn');
      const closeBtn = overlay.querySelector('.close-btn');
      menuBtn.onclick = ()=> { overlay.classList.add('open'); overlay.setAttribute('aria-hidden','false'); document.body.style.overflow = 'hidden'; };
      closeBtn.onclick = ()=> { overlay.classList.remove('open'); overlay.setAttribute('aria-hidden','true'); document.body.style.overflow = ''; };
      overlay.addEventListener('click', (e)=> { if(e.target === overlay){ overlay.classList.remove('open'); overlay.setAttribute('aria-hidden','true'); document.body.style.overflow = ''; } });

      // home link in overlay
      const homeLink = document.querySelector('#overlayMenu a[href="divas-index.html"]');
      if(homeLink) homeLink.addEventListener('click', (e)=>{ e.preventDefault(); document.getElementById('produtos').style.display = 'none'; document.getElementById('produto').style.display = ''; document.getElementById('breadcrumb').style.display = 'none'; overlay.classList.remove('open'); document.body.style.overflow = ''; window.history.pushState({}, '', window.location.pathname); });
    }

    /***** popstate handler (back/forward) *****/
    window.addEventListener('popstate', () => {
      const params = new URLSearchParams(window.location.search);
      const prod = params.get('produto');
      if(prod){
        (async ()=>{
          await catalogReady;
          const found = allProdutos.find(p => p.nome === prod) || allProdutos.find(p => normalizeText(p.nome||'') === normalizeText(prod)) || null;
          if(found){ showProdutoFromData(found); return; }
          const imagensRaw = params.get('imagens') || null;
          const opcoesRaw = params.get('opcoes') || null;
          const imgs = safeJSONparseMaybeEncoded(imagensRaw);
          const opts = safeJSONparseMaybeEncoded(opcoesRaw);
          if(imgs || opts){
            const produtoObj = {
              nome: prod,
              imagens: imgs || [],
              opcoes: opts || [],
              status: params.get('status') ? decodeURIComponent(params.get('status')) : '',
              descricao: params.get('descricao') ? decodeURIComponent(params.get('descricao')) : '',
              preco: params.get('preco') ? decodeURIComponent(params.get('preco')) : '',
              mensagem: params.get('mensagem') ? decodeURIComponent(params.get('mensagem')) : '',
              parcelamento: params.get('parcelamento') ? decodeURIComponent(params.get('parcelamento')) : ''
            };
            showProdutoFromData(produtoObj);
            return;
          }
          document.getElementById('produto').innerHTML = `<div style="padding:20px;text-align:center;">Produto "${prod}" não encontrado.</div>`;
        })();
      } else {
        if(allProdutos && allProdutos.length>0) renderProdutosGrid(allProdutos);
        document.getElementById('produto').style.display = 'none';
        document.getElementById('produtos').style.display = allProdutos && allProdutos.length>0 ? '' : 'none';
        document.getElementById('breadcrumb').style.display = 'none';
      }
    });

    /***** Inicialização: configura UI e carrega catálogo *****/
    (async function init(){
      setupUIHandlers();

      // se o produto vier com imagens/opcoes codificadas via URL (vindo da grade), mostramos direto
      if(paramProduto && (providedImagens || providedOpcoes)){
        const produtoObj = {
          nome: paramProduto,
          imagens: providedImagens || [],
          opcoes: providedOpcoes || [],
          status: urlParams.get('status') ? decodeURIComponent(urlParams.get('status')) : '',
          descricao: urlParams.get('descricao') ? decodeURIComponent(urlParams.get('descricao')) : '',
          preco: urlParams.get('preco') ? decodeURIComponent(urlParams.get('preco')) : '',
          mensagem: urlParams.get('mensagem') ? decodeURIComponent(urlParams.get('mensagem')) : '',
          parcelamento: urlParams.get('parcelamento') ? decodeURIComponent(urlParams.get('parcelamento')) : ''
        };
        showProdutoFromData(produtoObj);
        // carregar catálogo em background (para filtros funcionarem)
        fetchCatalogWithFallback().then(data=>{
          if(data && data.status === 'success'){ allProdutos = data.produtos || []; catalogLoaded = true; catalogResolve && catalogResolve(); }
          else if(Array.isArray(data)){ allProdutos = data; catalogLoaded = true; catalogResolve && catalogResolve(); }
          else { catalogLoaded = true; catalogResolve && catalogResolve(); }
        }).catch(()=>{ catalogLoaded = true; catalogResolve && catalogResolve(); });
        return;
      }

      // fetch catálogo (decide se abre produto por ?produto)
      try{
        const data = await fetchCatalogWithFallback();
        if(!data || data.status === 'error'){
          if(Array.isArray(data)) { allProdutos = data; }
          else {
            document.getElementById('produto').innerHTML = '<div style="padding:20px;text-align:center;">Não foi possível carregar o catálogo no momento.</div>';
            allProdutos = [];
            catalogLoaded = true; catalogResolve && catalogResolve();
            return;
          }
        } else {
          if(data.status === 'success' && Array.isArray(data.produtos)) allProdutos = data.produtos;
          else if(Array.isArray(data)) allProdutos = data;
          else if(data.produtos && Array.isArray(data.produtos)) allProdutos = data.produtos;
          else allProdutos = [];
        }

        catalogLoaded = true; catalogResolve && catalogResolve();

        // se veio ?produto=Nome, tenta encontrar e abrir
        if(paramProduto){
          const exact = allProdutos.find(p => p.nome === paramProduto);
          if(exact){ showProdutoFromData(exact); return; }
          const normalizedTarget = normalizeText(paramProduto);
          const found = allProdutos.find(p => normalizeText(p.nome||'') === normalizedTarget || normalizeText(p.nome||'').includes(normalizedTarget));
          if(found){ showProdutoFromData(found); return; }
          // não achou: avisa
          document.getElementById('produto').innerHTML = `<div style="padding:20px;text-align:center;">Produto "${paramProduto}" não encontrado.</div>`;
          return;
        }

        // por padrão mostra grade com todos os produtos
        renderProdutosGrid(allProdutos);
      }catch(err){
        console.error('Erro ao buscar catálogo', err);
        document.getElementById('produto').innerHTML = '<div style="padding:20px;text-align:center;">Erro ao carregar o catálogo</div>';
        allProdutos = [];
        catalogLoaded = true; catalogResolve && catalogResolve();
      }
    })();

    // debug helper
    window.forceReloadFromServer = function(){ fetchCatalogWithFallback().then(d=>{ if(d && d.status==='success'){ allProdutos = d.produtos||[]; renderProdutosGrid(allProdutos); } else if(Array.isArray(d)){ allProdutos = d; renderProdutosGrid(allProdutos); } }); };
  </script>
</body>
</html>
