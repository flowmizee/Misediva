<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Produto</title>
  <link rel="icon" type="image/png" href="divas.png">
  <style>
    /* --- Seu CSS original preservado --- */
    html, body { margin: 0; padding: 0; height: 100%; }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: Arial, sans-serif; background-color: #fff; display: flex; flex-direction: column; min-height: 100vh; }
    .nav-wrapper { position: sticky; top: 0; background: #fff; z-index: 1000; }
    .header { display: flex; justify-content: space-between; align-items: center; padding: 8px 16px; }
    .menu-icon, .bag-icon { font-size: 28px; cursor: pointer; position: relative; }
    .bag-icon .cart-count { position: absolute; top: -4px; right: -8px; background: #ff0000; color: #fff; font-size: 12px; padding: 2px 6px; border-radius: 12px; display: none; }
    .logo img { max-height: 80px; width: auto; cursor: pointer; }
    .search-container { display: flex; width: 100%; padding: 0 16px 16px; }
    .search-input { flex: 1; padding: 12px; border: 1px solid #ccc; border-radius: 8px 0 0 8px; outline: none; font-size: 16px; background-color: #f2f2f2; }
    .search-button { background-color: #ff69b4; border: none; padding: 0 16px; border-radius: 0 8px 8px 0; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .search-button img { height: 36px; width: auto; }
    .categories-container { display: flex; gap: 16px; overflow-x: auto; scroll-behavior: smooth; padding: 8px 16px 16px; }
    .category { cursor: pointer; white-space: nowrap; padding: 8px 0; font-weight: normal !important; color: #333; }  .main-content { flex: 1; display: flex; flex-direction: column; }
    .produtos-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 24px; padding: 16px; min-height: 300px; }
    .produto { cursor: pointer; }
    .produto img { width: 100%; height: 240px; object-fit: cover; border-radius: 8px; margin-bottom: 12px; }
    .produto .nome { font-size: 14px; font-weight: bold; margin-bottom: 8px; text-transform: capitalize; }
    .produto .preco { font-size: 20px; font-weight: bold; margin-bottom: 8px; }
    .produto .parcelamento, .produto .extra { font-size: 13px; margin-bottom: 8px; }
    .produto .extra { color: #007bff; }

    .produto-container { padding: 16px; min-height: 300px; }
    .breadcrumb-list { font-size: 14px; color: #666; margin-bottom: 16px; }
    .breadcrumb-list a { color: #007bff; text-decoration: none; }
    .carousel img { max-width: 100%; height: 350px; object-fit: cover; border-radius: 8px; }
    .carousel img { width: 100%; border-radius: 8px; }
    .badge { position: absolute; top: 8px; left: 8px; background: rgba(255,0,0,0.8); color: #fff; padding: 4px 8px; border-radius: 4px; font-size: 14px; }
    .counter { position: absolute; bottom: 8px; right: 8px; background: rgba(0,0,0,0.6); color: #fff; padding: 4px 8px; border-radius: 12px; font-size: 14px; }
    .thumbnails { display: flex; justify-content: center; gap: 8px; margin-bottom: 16px; }
    .thumbnails img { width: 60px; height: 60px; object-fit: cover; border: 2px solid #ddd; border-radius: 4px; cursor: pointer; }
    .thumbnails img.active { border-color: #007bff; }
    .produto-nome { font-size: 24px; font-weight: bold; color: #333; margin-bottom: 8px; }
    .produto-preco { font-size: 24px; font-weight: bold; color: #000; margin-bottom: 8px; }
    .produto-parcelamento { font-size: 15px; color: #666; margin-bottom: 8px; }
    .produto-extra { font-size: 14px; color: #007bff; margin-bottom: 16px; }
    .options { margin-bottom: 16px; }
    .options-label { font-size: 14px; margin-bottom: 4px; }
    .option-swatch { display: inline-block; padding: 6px 12px; border: 2px solid #ccc; border-radius: 4px; cursor: pointer; font-size: 14px; margin-right: 8px; }
    .option-swatch.selected { border-color: #000; }
    .purchase-controls { display: flex; align-items: center; gap: 8px; margin-bottom: 16px; }
    .qty-controls { display: flex; align-items: center; border: 1px solid #ccc; border-radius: 8px; }
    .qty-controls button { background: none; border: none; font-size: 18px; padding: 8px 12px; cursor: pointer; }
    .qty-controls .qty { padding: 0 12px; font-size: 18px; min-width: 24px; text-align: center; }
    .buy-btn { flex: 1; background-color: #ff69b4; color: #fff; border: none; padding: 12px; border-radius: 8px; font-size: 16px; cursor: pointer; position: relative; overflow: visible; }
    .info-section { font-size: 14px; color: #555; margin-bottom: 4px; }
    .descricao { font-size: 14px; color: #333; margin-top: 8px; line-height: 1.5; }
    hr { border: none; border-top: 1px solid #ddd; margin: 16px 0; }

    #breadcrumb { display: none; background: #fff; border-bottom: 1px solid #eee; padding: 8px 16px; }
    #breadcrumb .path { font-size: 14px; color: #007bff; cursor: pointer; text-decoration: underline; }
    #breadcrumb .separator { font-size: 14px; color: #555; margin: 0 8px; }
    #breadcrumb .crumbName { font-size: 14px; text-transform: capitalize; }
    .header-row { display: flex; justify-content: space-between; align-items: center; margin-top: 8px; }
    .header-row .title { font-weight: bold; font-size: 20px; text-transform: uppercase; }
    .header-row .count { font-size: 14px; color: #555; }

    #overlayMenu { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; transform: translateX(-100%); transition: transform 0.3s ease; z-index: 2000; padding: 60px 20px; display: flex; flex-direction: column; }
    #overlayMenu.open { transform: translateX(0); }
    #overlayMenu .close-btn { position: absolute; top: 16px; right: 16px; font-size: 32px; cursor: pointer; }
    #overlayMenu nav { display: flex; flex-direction: column; gap: 0; margin-top: 20px; }
    #overlayMenu nav a { font-size: 20px; color: #000; text-decoration: none; text-transform: uppercase; padding: 8px 0; }

    .site-footer { background-color: #ff69b4; color: #fff; padding: 16px; margin-top: auto; }
    .site-footer .footer-item { margin-bottom: 12px; font-size: 14px; }
    .site-footer .footer-item.instagram { margin-bottom: 32px; }
    .site-footer .footer-item.instagram img { width: 20px; height: auto; display: block; }
    .site-footer .footer-item a { color: inherit; text-decoration: none; }
    .site-footer .footer-item:last-child { margin-bottom: 0; }

    .flying-image {
      position: fixed;
      z-index: 9999;
      pointer-events: none;
      will-change: transform, opacity;
      transition: transform 700ms cubic-bezier(.2,.8,.2,1), opacity 700ms ease;
      border-radius: 8px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.25);
    }

    /* SKELETON para load rápido */
    .skeleton { width: 100%; display: grid; gap: 12px; }
    .skeleton .s-img { width: 100%; height: 350px; background: linear-gradient(90deg, #eee, #f5f5f5, #eee); background-size: 200% 100%; animation: shine 1.2s infinite; border-radius: 8px; }
    .skeleton .s-line { height: 18px; background: linear-gradient(90deg, #eee, #f5f5f5, #eee); background-size: 200% 100%; animation: shine 1.2s infinite; border-radius: 6px; }
    @keyframes shine { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

  </style>
  <!-- PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
  <div id="overlayMenu">
    <div class="close-btn">&times;</div>
    <nav>
      <a href="divas-index.html">Início</a>
      <a href="#" id="all-products-link">Produtos</a>
      <a href="miss-index.html">MISS FIT BEACHWEAR</a>
      <a href="divas-contato.html">Contato</a>
    </nav>
  </div>

  <div class="nav-wrapper">
    <header class="header">
      <div class="menu-icon" id="menuBtn">&#9776;</div>
      <a href="divas-index.html" class="logo">
        <img src="logodivas.webp" alt="Logo">
      </a>
      <a href="carrinho.html" class="bag-icon" id="cart-icon">
        &#128717;
        <span class="cart-count" id="cart-count">0</span>
      </a>
    </header>
    <div class="search-container">
      <input class="search-input" type="text" placeholder="O que você está procurando?" />
      <button class="search-button"><img src="lupa.webp" alt="Buscar" /></button>
    </div>
    <div id="cats" class="categories-container">
      <div class="category">BRINCOS</div>
      <div class="category">ANÉIS</div>
      <div class="category">BRACELETES</div>
      <div class="category">COLARES</div>
      <div class="category">CONJUNTOS</div>
      <div class="category">PULSEIRAS</div>
      <div class="category">PERFUMES</div>
      <div class="category">BOLSAS</div>
      <div class="category">CINTOS</div>
      <div class="category">ÓCULOS</div>
    </div>
  </div>

  <div class="main-content">
    <!-- Breadcrumb -->
    <div id="breadcrumb">
      <span class="path">Início</span>
      <span class="separator">&gt;</span>
      <span class="crumbName"></span>
      <div class="header-row">
        <span class="title"></span>
        <span class="count"></span>
      </div>
    </div>

    <!-- Produto -->
    <div class="produto-container" id="produto"></div>

    <!-- Grid (invisível até uso) -->
    <div id="produtos" class="produtos-grid" style="display:none;"></div>
  </div>

  <footer class="site-footer">
    <div class="footer-item instagram">
      <a href="https://www.instagram.com/divasbijouxshoes?igsh=MW55M2QzbTJnaGF4bg==" target="_blank" rel="noopener">
        <img src="instagramicon.png" alt="Instagram">
      </a>
    </div>
    <div class="footer-item">
      <a href="https://wa.me/5598992124926" target="_blank" rel="noopener">
        5598992124926
      </a>
    </div>
    <div class="footer-item">
      <a href="tel:+5589982124926">
        98992124926
      </a>
    </div>
    <div class="footer-item copyright">
      © Flowmize – 2025. Todos os direitos reservados.
    </div>
  </footer>

  <script>
    /* ============================
       CONFIG - troque só a URL abaixo pelo CSV público (ex: Google Sheets ?output=csv)
       ============================ */
    const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTpnms1jkq5n5KfiipHhMWrJIrc-PYiJy-s8D4wv8_LZ2V0a4AExSSz5yPcK36j13r9aYA5aQzxqsbF/pub?output=csv';
    const CART_KEY = 'cartItems';
    const CATALOG_KEY = 'catalogData';
    const CATALOG_TIMESTAMP_KEY = 'catalogTimestamp';
    const CATALOG_CACHE_DURATION = 30 * 60 * 1000; // 30 minutos

    /* ============================
       Helpers de cache do catálogo
       ============================ */
    function getCatalogFromCache() {
      try {
        const cachedData = localStorage.getItem(CATALOG_KEY);
        const cachedTimestamp = localStorage.getItem(CATALOG_TIMESTAMP_KEY);
        if (!cachedData || !cachedTimestamp) return null;
        const now = Date.now();
        if (now - parseInt(cachedTimestamp,10) > CATALOG_CACHE_DURATION) return null;
        return JSON.parse(cachedData);
      } catch { return null; }
    }
    function setCatalogToCache(data) {
      try {
        localStorage.setItem(CATALOG_KEY, JSON.stringify(data));
        localStorage.setItem(CATALOG_TIMESTAMP_KEY, Date.now().toString());
      } catch (e) { console.warn('cache write failed', e); }
    }

    /* ============================
       Carrinho (igual ao seu)
       ============================ */
    function getCartItems(){ try { return JSON.parse(localStorage.getItem(CART_KEY)) || []; } catch { return []; } }
    function setCartItems(items){ localStorage.setItem(CART_KEY, JSON.stringify(items)); renderCartCount(); }
    function renderCartCount(){ const el = document.getElementById('cart-count'); const items = getCartItems(); const total = items.reduce((s,it) => s + (parseInt(it.quantidade||0,10)||0), 0); el.textContent = total; el.style.display = total>0 ? 'inline-block' : 'none'; }
    document.addEventListener('DOMContentLoaded', ()=> renderCartCount());

    /* ============================
       Estado
       ============================ */
    let allProdutos = [];
    let lastRenderedList = [];
    let catalogLoaded = false;
    let catalogResolve;
    const catalogReady = new Promise(resolve => { catalogResolve = resolve; });

    /* ============================
       URL params helpers
       ============================ */
    function safeJSONparseMaybeEncoded(param){
      if(!param) return null;
      try {
        const decoded = decodeURIComponent(param);
        return JSON.parse(decoded);
      } catch(e1){
        try { return JSON.parse(param); } catch(e2){
          if(typeof param === 'string' && param.indexOf(',')!==-1) return param.split(',').map(s=>s.trim()).filter(Boolean);
          return null;
        }
      }
    }
    function normalizeText(text){
      if(!text) return '';
      try { return text.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim(); }
      catch { return String(text).toLowerCase().trim(); }
    }

    const urlParams = new URLSearchParams(window.location.search);
    const paramProduto = urlParams.get('produto') ? decodeURIComponent(urlParams.get('produto')) : '';
    const paramImagensRaw = urlParams.get('imagens') || null;
    const paramOpcoesRaw = urlParams.get('opcoes') || null;
    const providedImagens = safeJSONparseMaybeEncoded(paramImagensRaw);
    const providedOpcoes = safeJSONparseMaybeEncoded(paramOpcoesRaw);

    /* ============================
       UI: show skeleton (rápido) e mostrar produto a partir de dados
       ============================ */
    function showSkeleton() {
      const container = document.getElementById('produto');
      container.style.display = '';
      container.innerHTML = `
        <div class="skeleton">
          <div class="s-img"></div>
          <div style="display:flex;flex-direction:column;gap:8px">
            <div class="s-line" style="width:70%"></div>
            <div class="s-line" style="width:40%"></div>
            <div class="s-line" style="width:30%"></div>
            <div class="s-line" style="width:100%;height:80px"></div>
          </div>
        </div>
      `;
    }

    function showProdutoFromData(prod){
      if(!prod) return;
      window.scrollTo({top:0,behavior:'smooth'});
      const container = document.getElementById('produto');
      document.getElementById('produtos').style.display = 'none';
      document.getElementById('breadcrumb').style.display = 'none';

      const nome = prod.nome || '';
      const images = Array.isArray(prod.imagens) ? prod.imagens : (prod.imagens ? [prod.imagens] : []);
      const options = Array.isArray(prod.opcoes) ? prod.opcoes : (prod.opcoes ? [prod.opcoes] : []);
      const status = prod.status || '';
      const desc = prod.descricao || '';
      let preco = prod.preco || '';
      const extra = prod.mensagem || '';
      const parc = prod.parcelamento || '';

      preco = (preco||'').toString().trim();
      preco = preco.replace(/[^\d.,]/g,'');
      if(preco && !preco.includes(',')){
        if(preco.indexOf('.') !== -1) preco = preco.replace('.',','); else preco = preco + ',00';
      }

      let html = `<div class="breadcrumb-list"><a href="divas-index.html">Início</a> &gt; ${nome}</div>`;
      html += `<div class="carousel" style="position:relative;">${status ? `<div class="badge">${status}</div>` : ''}<img id="carousel-image" src="" alt="${nome}"><div class="counter" id="image-counter"></div></div>`;
      html += `<div class="thumbnails" id="thumbnails"></div>`;
      html += `<div class="produto-nome">${nome}</div>`;
      html += `<div class="produto-preco">R$ ${preco}</div>`;
      if(parc) html += `<div class="produto-parcelamento">${parc}</div>`;
      if(extra) html += `<div class="produto-extra">${extra}</div>`;
      if(options && options.length) html += `<div class="options"><div class="options-label">Opções:</div><div id="option-list"></div></div>`;

      html += `
        <div class="purchase-controls">
          <div class="qty-controls">
            <button id="decrease">-</button>
            <div class="qty" id="quantity">1</div>
            <button id="increase">+</button>
          </div>
          <button class="buy-btn" id="buy-btn">ADICIONAR AO CARRINHO</button>
        </div>
        <strong>Compra protegida</strong>
        <div class="info-section">Seus dados cuidados durante toda a compra.</div><hr>
        <strong>Trocas e devoluções</strong>
        <div class="info-section">Se não gostar, você pode trocar ou devolver em até 7 dias após a entrega.</div><hr>
        <strong>Descrição</strong>
        <div class="descricao">${desc}</div>
      `;
      container.innerHTML = html;

      // images + thumbs
      const imgEl = document.getElementById('carousel-image');
      const counterEl = document.getElementById('image-counter');
      const thumbsEl = document.getElementById('thumbnails');

      let idx = 0;
      function showImage(i){
        if(!images[i]) return;
        idx = i;
        imgEl.src = images[i];
        counterEl.textContent = `${i+1}/${images.length}`;
        thumbsEl.querySelectorAll('img').forEach((t,j)=> t.classList.toggle('active', j===i));
      }

      images.forEach((src,i)=>{
        const t = document.createElement('img');
        t.src = src;
        t.alt = nome;
        t.onclick = ()=> showImage(i);
        thumbsEl.appendChild(t);
      });
      if(images.length>0){ showImage(0); const f=thumbsEl.querySelector('img'); if(f) f.classList.add('active'); } else { imgEl.style.display='none'; counterEl.style.display='none'; }

      // options
      if(options && options.length){
        const list = document.getElementById('option-list');
        options.forEach(opt=>{
          const sw = document.createElement('div');
          sw.className='option-swatch'; sw.textContent = opt;
          sw.onclick = ()=>{ document.querySelectorAll('.option-swatch').forEach(x=>x.classList.remove('selected')); sw.classList.add('selected'); };
          list.appendChild(sw);
        });
      }

      // qty controls
      let qty = 1;
      document.getElementById('decrease').onclick = ()=>{ if(qty>1) qty--; document.getElementById('quantity').textContent = qty; };
      document.getElementById('increase').onclick = ()=>{ qty++; document.getElementById('quantity').textContent = qty; };

      // buy
      document.getElementById('buy-btn').onclick = ()=>{
        const opcEl = document.querySelector('.option-swatch.selected');
        const opcao = opcEl ? opcEl.textContent : null;
        const productName = nome;
        const precoText = preco;
        const quantidade = parseInt(document.getElementById('quantity').textContent,10) || 1;
        const sourceImg = document.getElementById('carousel-image');
        if(sourceImg && sourceImg.src){
          flyImageToCart(sourceImg).then(()=> addToCartAndPersist({nome:productName,preco:precoText,quantidade,opcao,imagens:images}));
        } else {
          addToCartAndPersist({nome:productName,preco:precoText,quantidade,opcao,imagens:images});
        }
      };
    }

    /* ============================
       Add to cart
       ============================ */
    function addToCartAndPersist(item){
      const items = getCartItems();
      const exists = items.find(i => i.nome === item.nome && (i.opcao||'') === (item.opcao||''));
      if(exists) exists.quantidade = (parseInt(exists.quantidade||0,10)||0) + (parseInt(item.quantidade||0,10)||0);
      else { item.quantidade = parseInt(item.quantidade||0,10)||0; items.push(item); }
      setCartItems(items);
    }

    /* ============================
       flying animation
       ============================ */
    function flyImageToCart(sourceImg){
      return new Promise((resolve)=>{
        try{
          const rect = sourceImg.getBoundingClientRect();
          const clone = sourceImg.cloneNode(true);
          clone.className = 'flying-image';
          clone.style.width = rect.width + 'px';
          clone.style.height = rect.height + 'px';
          clone.style.left = rect.left + 'px';
          clone.style.top = rect.top + 'px';
          clone.style.opacity = '1';
          document.body.appendChild(clone);
          const cartIcon = document.getElementById('cart-icon');
          const cartRect = cartIcon.getBoundingClientRect();
          const targetX = cartRect.left + (cartRect.width/2) - (rect.left + rect.width/2);
          const targetY = cartRect.top + (cartRect.height/2) - (rect.top + rect.height/2);
          const scale = 0.18;
          requestAnimationFrame(()=> {
            clone.style.transform = `translate(${targetX}px, ${targetY}px) scale(${scale})`;
            clone.style.opacity = '0.2';
          });
          clone.addEventListener('transitionend', function handler(){
            clone.removeEventListener('transitionend', handler);
            clone.remove();
            resolve();
          });
          setTimeout(()=>{ if(document.body.contains(clone)){ clone.remove(); resolve(); } }, 1200);
        } catch(e){ console.warn('fly failed',e); resolve(); }
      });
    }

    /* ============================
       PARSE RÁPIDO: procura produto linha-a-linha com PapaParse e mostra imediatamente
       ============================ */
    function parseAndShowProductFast(productName) {
      return new Promise((resolve) => {
        let rowIndex = -1;
        let found = false;
        showSkeleton();
        Papa.parse(CSV_URL, {
          download: true,
          skipEmptyLines: true,
          step: function(results, parser) {
            rowIndex++;
            const row = results.data;
            if (rowIndex === 0) return; // pular header
            if (!row || !row[2]) return;
            const nomeCell = (row[2]||'').toString().trim();
            if (nomeCell === productName) {
              found = true;
              // monta produto com a linha encontrada
              const c = row;
              const produtoObj = {
                nome: c[2]?.toString().trim() || '',
                imagens: [c[3],c[4],c[5]].map(u=>u?.toString().trim()).filter(Boolean),
                opcoes: [c[6],c[7],c[8]].map(o=>o?.toString().trim()).filter(Boolean),
                status: (c[9]||'').toString().trim()||'',
                descricao: (c[10]||'').toString().trim()||'',
                preco: (c[11]||'').toString().trim()||'',
                mensagem: (c[12]||'').toString().trim()||'',
                parcelamento: (c[13]||'').toString().trim()||''
              };
              showProdutoFromData(produtoObj);
              parser.abort();
              resolve(true);
            }
          },
          error: function(err){
            console.error('Parse fast error', err);
            resolve(false);
          },
          complete: function(){
            if(!found){
              const container = document.getElementById('produto');
              container.style.display = '';
              container.innerHTML = `<div style="padding:20px;text-align:center;">Produto "<strong>${productName}</strong>" não encontrado.</div>`;
              resolve(false);
            }
          }
        });
      });
    }

    /* ============================
       PARSE COMPLETO para popular allProdutos (background)
       ============================ */
    function parseAllProductsBackground() {
      if (allProdutos && allProdutos.length > 0) return Promise.resolve(allProdutos);
      const cached = getCatalogFromCache();
      if (cached && Array.isArray(cached) && cached.length>0) {
        allProdutos = cached;
        catalogLoaded = true; catalogResolve && catalogResolve();
        return Promise.resolve(allProdutos);
      }
      return new Promise((resolve) => {
        Papa.parse(CSV_URL, {
          download: true,
          skipEmptyLines: true,
          complete: function(results) {
            const rows = results.data || [];
            const lines = rows.slice(1).map(r => r.map(c => (c === undefined ? '' : String(c))));
            allProdutos = [];
            lines.forEach(cells => {
              if (!cells || !cells[2] || !cells[2].toString().trim()) return;
              allProdutos.push({
                nome: cells[2].toString().trim(),
                imagens: [cells[3],cells[4],cells[5]].map(u=>u?.toString().trim()).filter(u=>u),
                opcoes: [cells[6],cells[7],cells[8]].map(o=>o?.toString().trim()).filter(o=>o),
                status: (cells[9] || '').toString().trim() || '',
                descricao: (cells[10] || '').toString().trim() || '',
                preco: (cells[11] || '').toString().trim() || '',
                mensagem: (cells[12] || '').toString().trim() || '',
                parcelamento: (cells[13] || '').toString().trim() || ''
              });
            });
            setCatalogToCache(allProdutos);
            resolve(allProdutos);
          },
          error: function(err){
            console.error('Parse completo error', err);
            resolve([]);
          }
        });
      });
    }

    /* ============================
       Render grid (uso do catálogo)
       ============================ */
    function renderProdutosGrid(list){
      const g = document.getElementById('produtos');
      document.getElementById('produto').style.display = 'none';
      g.style.display = 'grid';
      g.innerHTML = '';
      lastRenderedList = (list || []).slice();

      if(!list || list.length===0){
        g.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:20px">Nenhum produto encontrado</div>';
        return;
      }
      list.forEach((p)=>{
        if(!p || !p.nome) return;
        const d = document.createElement('div'); d.className='produto';
        d.setAttribute('data-nome', p.nome);
        const img = (p.imagens && p.imagens[0]) ? p.imagens[0] : '';
        d.innerHTML = `
          <img src="${img}" alt="${p.nome}" onerror="this.src='https://via.placeholder.com/300x300?text=Imagem+N%C3%A3o+Encontrada'">
          <div class="nome">${p.nome}</div>
          <div class="preco">${p.preco || ''}</div>
          ${p.parcelamento ? `<div class="parcelamento">${p.parcelamento}</div>` : ''}
          ${p.mensagem ? `<div class="extra">${p.mensagem}</div>` : ''}
        `;
        d.addEventListener('click', (ev) => {
          ev.stopPropagation();
          const params = new URLSearchParams();
          params.set('produto', p.nome || '');
          if(p.imagens) params.set('imagens', encodeURIComponent(JSON.stringify(p.imagens)));
          if(p.opcoes) params.set('opcoes', encodeURIComponent(JSON.stringify(p.opcoes)));
          if(p.status) params.set('status', encodeURIComponent(p.status));
          if(p.descricao) params.set('descricao', encodeURIComponent(p.descricao));
          if(p.preco) params.set('preco', encodeURIComponent(p.preco));
          if(p.mensagem) params.set('mensagem', encodeURIComponent(p.mensagem));
          if(p.parcelamento) params.set('parcelamento', encodeURIComponent(p.parcelamento));
          window.location.href = window.location.pathname + '?' + params.toString();
        });
        g.appendChild(d);
      });
    }

    /* ============================
       Category mapping & filters simples
       ============================ */
    const categoryMap = {
      'BRINCOS':['brinco','brincos'],
      'ANÉIS':['anel','aneis','anéis'],
      'BRACELETES':['bracelete','braceletes','bracelet'],
      'COLARES':['colar','colares'],
      'CONJUNTOS':['conjunto','conjuntos','kit','kits'],
      'PULSEIRAS':['pulseira','pulseiras'],
      'PERFUMES':['perfume','perfumes'],
      'BOLSAS':['bolsa','bolsas'],
      'CINTOS':['cinto','cintos'],
      'ÓCULOS':['óculos','oculos']
    };
    function getTermsForCategory(cat){
      const key = (cat||'').toUpperCase();
      return categoryMap[key] || [normalizeText(cat)];
    }
    function filterByCategoryName(catName){
      const terms = getTermsForCategory(catName);
      return (allProdutos || []).filter(p=>{
        if(!p) return false;
        const catField = normalizeText(p.categoria || p.category || '');
        if(catField && terms.some(t=> catField.includes(t))) return true;
        const tagField = normalizeText(p.tag || p.tags || '');
        if(tagField && terms.some(t=> tagField.includes(t))) return true;
        const nm = normalizeText(p.nome || '');
        if(nm && terms.some(t=> nm.includes(t))) return true;
        return false;
      });
    }

    /* ============================
       UI handlers setup (categories, search, menu, breadcrumb)
       ============================ */
    function setupUIHandlers(){
      // categories
      document.querySelectorAll('.category').forEach(el=>{
        el.addEventListener('click', async ()=>{
          await catalogReady;
          const name = el.textContent.trim();
          const filtered = filterByCategoryName(name);
          document.getElementById('produtos').style.display = '';
          renderProdutosGrid(filtered);
          document.getElementById('breadcrumb').style.display = 'block';
          document.querySelector('#breadcrumb .path').textContent = 'Início';
          document.querySelector('#breadcrumb .crumbName').textContent = name.toLowerCase();
          document.querySelector('#breadcrumb .header-row .title').textContent = name.toUpperCase();
          document.querySelector('#breadcrumb .header-row .count').textContent = `${filtered.length} produto${filtered.length !== 1 ? 's' : ''}`;
          document.getElementById('produto').style.display = 'none';
        });
      });

      // all products link
      document.getElementById('all-products-link').addEventListener('click', async (e)=>{
        e.preventDefault();
        await catalogReady;
        const sorted = [...(allProdutos||[])].sort((a,b)=> (a.nome||'').localeCompare(b.nome||'','pt',{sensitivity:'base'}));
        renderProdutosGrid(sorted);
        document.getElementById('breadcrumb').style.display = 'block';
        document.querySelector('#breadcrumb .path').textContent = 'Início';
        document.querySelector('#breadcrumb .crumbName').textContent = 'Todos os Produtos';
        document.querySelector('#breadcrumb .header-row .title').textContent = 'TODOS OS PRODUTOS';
        document.querySelector('#breadcrumb .header-row .count').textContent = `${sorted.length} produto${sorted.length !==1 ? 's' : ''}`;
        document.getElementById('overlayMenu').classList.remove('open');
        document.body.style.overflow = '';
      });

      // breadcrumb back
      document.querySelector('#breadcrumb .path').addEventListener('click', ()=>{
        document.getElementById('produtos').style.display = 'none';
        document.getElementById('produto').style.display = '';
        document.getElementById('breadcrumb').style.display = 'none';
        window.history.pushState({}, '', window.location.pathname);
      });

      // search
      const si = document.querySelector('.search-input');
      const sb = document.querySelector('.search-button');
      si.addEventListener('input', async ()=>{
        await catalogReady;
        const t = si.value.trim();
        if(t === ''){
          document.getElementById('produtos').style.display = 'none';
          document.getElementById('produto').style.display = '';
          document.getElementById('breadcrumb').style.display = 'none';
          return;
        }
        const normalized = normalizeText(t);
        const filtered = (allProdutos || []).filter(p => normalizeText(p.nome||'').includes(normalized));
        renderProdutosGrid(filtered);
        document.getElementById('breadcrumb').style.display = 'block';
        document.querySelector('#breadcrumb .path').textContent = 'Início';
        document.querySelector('#breadcrumb .crumbName').textContent = t.toLowerCase();
        document.querySelector('#breadcrumb .header-row .title').textContent = t.toUpperCase();
        document.querySelector('#breadcrumb .header-row .count').textContent = `${filtered.length} produto${filtered.length !== 1 ? 's' : ''}`;
      });
      sb.addEventListener('click', ()=> si.dispatchEvent(new Event('input')));

      // overlay open/close
      const overlay = document.getElementById('overlayMenu');
      const menuBtn = document.getElementById('menuBtn') || document.querySelector('.menu-icon');
      const closeBtn = overlay.querySelector('.close-btn');
      menuBtn.onclick = ()=> { overlay.classList.add('open'); overlay.setAttribute('aria-hidden','false'); document.body.style.overflow = 'hidden'; };
      closeBtn.onclick = ()=> { overlay.classList.remove('open'); overlay.setAttribute('aria-hidden','true'); document.body.style.overflow = ''; };
      overlay.addEventListener('click', (e)=>{ if(e.target === overlay){ overlay.classList.remove('open'); overlay.setAttribute('aria-hidden','true'); document.body.style.overflow = ''; } });

      // click card delegation (backup)
      document.getElementById('produtos').addEventListener('click', (ev) => {
        const card = ev.target.closest('.produto');
        if(!card) return;
        const name = card.getAttribute('data-nome');
        if(!name) return;
        let prod = (lastRenderedList || []).find(x => x && x.nome === name) || (allProdutos || []).find(x => x && x.nome === name) || null;
        if(!prod){
          const norm = normalizeText(name);
          prod = (lastRenderedList || []).find(x => normalizeText(x.nome||'') === norm) || (allProdutos || []).find(x => normalizeText(x.nome||'') === norm) || null;
        }
        if(prod){
          const p = prod;
          const params = new URLSearchParams();
          params.set('produto', p.nome || '');
          if(p.imagens) params.set('imagens', encodeURIComponent(JSON.stringify(p.imagens)));
          if(p.opcoes) params.set('opcoes', encodeURIComponent(JSON.stringify(p.opcoes)));
          if(p.status) params.set('status', encodeURIComponent(p.status));
          if(p.descricao) params.set('descricao', encodeURIComponent(p.descricao));
          if(p.preco) params.set('preco', encodeURIComponent(p.preco));
          if(p.mensagem) params.set('mensagem', encodeURIComponent(p.mensagem));
          if(p.parcelamento) params.set('parcelamento', encodeURIComponent(p.parcelamento));
          window.location.href = window.location.pathname + '?' + params.toString();
        }
      });
    }

    /* ============================
       Inicialização principal
       ============================ */
    (async function init(){
      setupUIHandlers();

      // Use cache se disponível
      const cachedCatalog = getCatalogFromCache();
      if (cachedCatalog && Array.isArray(cachedCatalog) && cachedCatalog.length>0) {
        allProdutos = cachedCatalog;
        catalogLoaded = true; catalogResolve && catalogResolve();
      }

      // Se o paramProduto veio com imagens/opcoes já embutidos, monta imediatamente (mais rápido)
      if(paramProduto && (providedImagens || providedOpcoes)){
        const produtoObj = {
          nome: paramProduto,
          imagens: providedImagens || [],
          opcoes: providedOpcoes || [],
          status: urlParams.get('status') ? decodeURIComponent(urlParams.get('status')) : '',
          descricao: urlParams.get('descricao') ? decodeURIComponent(urlParams.get('descricao')) : '',
          preco: urlParams.get('preco') ? decodeURIComponent(urlParams.get('preco')) : '',
          mensagem: urlParams.get('mensagem') ? decodeURIComponent(urlParams.get('mensagem')) : '',
          parcelamento: urlParams.get('parcelamento') ? decodeURIComponent(urlParams.get('parcelamento')) : ''
        };
        showProdutoFromData(produtoObj);
        // popula catálogo em background
        parseAllProductsBackground().then(data=>{ allProdutos = data || allProdutos; catalogLoaded = true; catalogResolve && catalogResolve(); }).catch(()=>{ catalogLoaded = true; catalogResolve && catalogResolve(); });
        return;
      }

      // Se cache tem e param não, renderiza grid
      if (!paramProduto && cachedCatalog && cachedCatalog.length>0){
        renderProdutosGrid(cachedCatalog);
        // atualiza cache em background
        parseAllProductsBackground().catch(()=>{});
        return;
      }

      // Se tem produto no query string: tenta encontrar rápido e mostrar
      if (paramProduto){
        await parseAndShowProductFast(paramProduto);
        // em seguida popula catálogo completo em bg
        parseAllProductsBackground().then(data=>{ allProdutos = data || allProdutos; catalogLoaded = true; catalogResolve && catalogResolve(); }).catch(()=>{ catalogLoaded = true; catalogResolve && catalogResolve(); });
        return;
      }

      // Caso padrão: carregar catálogo completo e renderizar grid
      try{
        const data = await parseAllProductsBackground();
        allProdutos = data || [];
        catalogLoaded = true; catalogResolve && catalogResolve();
        renderProdutosGrid(allProdutos);
      } catch(err){
        console.error('Erro no carregamento inicial do CSV', err);
        document.getElementById('produto').innerHTML = '<div style="padding:20px;text-align:center;">Erro ao carregar o catálogo</div>';
        allProdutos = []; catalogLoaded = true; catalogResolve && catalogResolve();
      }
    })();

    /* ============================
       Popstate (back/forward)
       ============================ */
    window.addEventListener('popstate', () => {
      const params = new URLSearchParams(window.location.search);
      const prod = params.get('produto');
      if(prod){
        (async ()=>{
          await catalogReady;
          const found = allProdutos.find(p => p.nome === prod) || allProdutos.find(p => normalizeText(p.nome||'') === normalizeText(prod)) || null;
          if(found){ showProdutoFromData(found); return; }
          const imagensRaw = params.get('imagens') || null;
          const opcoesRaw = params.get('opcoes') || null;
          const imgs = safeJSONparseMaybeEncoded(imagensRaw);
          const opts = safeJSONparseMaybeEncoded(opcoesRaw);
          if(imgs || opts){
            const produtoObj = {
              nome: prod,
              imagens: imgs || [],
              opcoes: opts || [],
              status: params.get('status') ? decodeURIComponent(params.get('status')) : '',
              descricao: params.get('descricao') ? decodeURIComponent(params.get('descricao')) : '',
              preco: params.get('preco') ? decodeURIComponent(params.get('preco')) : '',
              mensagem: params.get('mensagem') ? decodeURIComponent(params.get('mensagem')) : '',
              parcelamento: params.get('parcelamento') ? decodeURIComponent(params.get('parcelamento')) : ''
            };
            showProdutoFromData(produtoObj);
            return;
          }
          document.getElementById('produto').innerHTML = `<div style="padding:20px;text-align:center;">Produto "${prod}" não encontrado.</div>`;
        })();
      } else {
        if(allProdutos && allProdutos.length>0) renderProdutosGrid(allProdutos);
        document.getElementById('produto').style.display = 'none';
        document.getElementById('produtos').style.display = allProdutos && allProdutos.length>0 ? '' : 'none';
        document.getElementById('breadcrumb').style.display = 'none';
      }
    });

    /* ============================
       Expor função de força (dev)
       ============================ */
    window.forceReloadFromCSV = function(){
      // limpa cache e força recarregar
      localStorage.removeItem(CATALOG_KEY);
      localStorage.removeItem(CATALOG_TIMESTAMP_KEY);
      parseAllProductsBackground().then(d=>{ allProdutos = d || []; renderProdutosGrid(allProdutos); });
    };

    /* ============================
       Atualiza contador de carrinho quando voltar da outra aba
       ============================ */
    document.addEventListener('visibilitychange', ()=>{ if(!document.hidden) renderCartCount(); });

  </script>
</body>
</html>
